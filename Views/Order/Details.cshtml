@model BTL.Web.Models.OrderWithDetails
@{
    ViewData["Title"] = $"Chi tiết đơn hàng #{Model.order_id}";
}

@section Styles {
    <link rel="stylesheet" href="~/css/order-management.css" />
    <style>
        .order-details-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .order-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
        }

        .order-info {
            padding: 20px;
        }

        .info-row {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
            margin-right: 15px;
        }

        .info-value {
            flex: 1;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-chua_hoan_thanh {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-hoan_thanh {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-da_huy {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .order-items-table {
            margin-top: 20px;
        }

        .order-history {
            margin-top: 20px;
        }

        .history-item {
            border-left: 3px solid #007bff;
            padding-left: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 0 8px 8px 0;
        }

        .history-time {
            font-size: 0.9em;
            color: #6c757d;
        }

        .history-status {
            font-weight: 600;
            margin: 5px 0;
        }

        .history-note {
            font-style: italic;
            color: #495057;
        }

        /* Hóa đơn modal styles */
        .invoice-modal-content {
            background: white;
            border-radius: 8px;
            padding: 0;
        }

        .invoice-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            text-align: center;
        }

        .invoice-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .invoice-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .invoice-body {
            padding: 20px;
        }

        .invoice-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-section h5 {
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 3px 0;
            font-size: 0.9rem;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
        }

        .info-value {
            color: #495057;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .items-table th,
        .items-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .items-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .items-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .total-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 1rem;
        }

        .total-label {
            font-weight: 600;
            color: #495057;
        }

        .total-amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #28a745;
        }

        .invoice-footer {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-radius: 0 0 8px 8px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="fas fa-receipt"></i> Chi tiết đơn hàng #@Model.order_id</h1>
            <p class="text-muted">Thông tin chi tiết và lịch sử xử lý đơn hàng</p>
        </div>
        <div>
            <a href="/Order/AllOrders" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
            @if (Model.trang_thai != "HOAN_THANH" && Model.trang_thai != "DA_HUY")
            {
                <a href="/Order/Workflow/@Model.order_id" class="btn btn-primary">
                    <i class="fas fa-tasks"></i> Xử lý đơn hàng
                </a>
            }
            <button type="button" class="btn btn-success" onclick="showXuatHoaDonModal(@Model.order_id)">
                <i class="fas fa-receipt"></i> Xuất hoá đơn
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Order Information -->
        <div class="col-md-8">
            <div class="order-details-card">
                <div class="order-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Đơn hàng #@Model.order_id</h3>
                        <span class="status-badge status-@Model.trang_thai.ToLower()">
                            @GetStatusText(Model.trang_thai)
                        </span>
                    </div>
                </div>

                <div class="order-info">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-clock"></i> Thời gian:</span>
                                <span class="info-value">@Model.thoi_diem_dat.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>

                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-users"></i> Số khách:</span>
                                <span class="info-value">@(Model.so_khach ?? 0) người</span>
                            </div>

                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-utensils"></i> Loại:</span>
                                <span class="info-value">
                                    <span class="badge @(Model.la_mang_ve ? "bg-info" : "bg-success")">
                                        @(Model.la_mang_ve ? "Mang về" : "Ăn tại chỗ")
                                    </span>
                                </span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            @if (!string.IsNullOrEmpty(Model.ban_so_hieu))
                            {
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-table"></i> Bàn:</span>
                                    <span class="info-value">
                                        Bàn @Model.ban_so_hieu
                                        @if (Model.ban_suc_chua.HasValue)
                                        {
                                            <span class="text-muted">(@Model.ban_suc_chua người)</span>
                                        }
                                    </span>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(Model.khach_hang_ten))
                            {
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-user"></i> Khách hàng:</span>
                                    <span class="info-value">@Model.khach_hang_ten</span>
                                </div>

                                @if (!string.IsNullOrEmpty(Model.khach_hang_sdt))
                                {
                                    <div class="info-row">
                                        <span class="info-label"><i class="fas fa-phone"></i> SĐT:</span>
                                        <span class="info-value">@Model.khach_hang_sdt</span>
                                    </div>
                                }
                            }

                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-money-bill"></i> Tổng tiền:</span>
                                <span class="info-value">
                                    <strong class="text-success">@(Model.tong_tien?.ToString("N0") ?? "0") VNĐ</strong>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            @if (Model.OrderItems != null && Model.OrderItems.Any())
            {
                <div class="order-details-card">
                    <div class="order-header">
                        <h4 class="mb-0"><i class="fas fa-list"></i> Danh sách món ăn</h4>
                    </div>

                    <div class="order-info">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Món ăn</th>
                                        <th>Loại</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.OrderItems)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@item.ten_mon</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">@item.loai_mon</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">@item.so_luong</span>
                                            </td>
                                            <td>@(item.gia?.ToString("N0") ?? "0") VNĐ</td>
                                            <td>
                                                <strong>@((item.gia * item.so_luong)?.ToString("N0") ?? "0") VNĐ</strong>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th colspan="4" class="text-end">Tổng cộng:</th>
                                        <th class="text-success">@(Model.tong_tien?.ToString("N0") ?? "0") VNĐ</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Order History -->
        <div class="col-md-4">
            <div class="order-details-card">
                <div class="order-header">
                    <h4 class="mb-0"><i class="fas fa-history"></i> Lịch sử xử lý</h4>
                </div>

                <div class="order-info">
                    @if (Model.LichSuThucHiens != null && Model.LichSuThucHiens.Any())
                    {
                        <div class="order-history">
                            @foreach (var history in Model.LichSuThucHiens.OrderBy(h => h.thoi_diem_bat_dau))
                            {
                                <div class="history-item">
                                    <div class="history-time">
                                        <i class="fas fa-clock"></i>
                                        @history.thoi_diem_bat_dau?.ToString("dd/MM/yyyy HH:mm")
                                        @if (history.thoi_diem_ket_thuc.HasValue)
                                        {
                                            <span> - @history.thoi_diem_ket_thuc.Value.ToString("HH:mm")</span>
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(history.ten_buoc))
                                    {
                                        <div class="history-status">
                                            <i class="fas fa-tasks"></i> @history.ten_buoc
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(history.nhan_vien_ten))
                                    {
                                        <div class="text-muted">
                                            <i class="fas fa-user"></i> @history.nhan_vien_ten
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(history.ghi_chu))
                                    {
                                        <div class="history-note">
                                            <i class="fas fa-comment"></i> @history.ghi_chu
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-info-circle"></i>
                            <p>Chưa có lịch sử xử lý</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Actions -->
            @if (Model.trang_thai != "HOAN_THANH" && Model.trang_thai != "DA_HUY")
            {
                <div class="order-details-card">
                    <div class="order-header">
                        <h4 class="mb-0"><i class="fas fa-cogs"></i> Thao tác</h4>
                    </div>

                    <div class="order-info">
                        <div class="d-grid gap-2">
                            <a href="/Order/Workflow/@Model.order_id" class="btn btn-primary">
                                <i class="fas fa-tasks"></i> Xử lý đơn hàng
                            </a>

                            <button type="button" class="btn btn-danger" onclick="showCancelModal(@Model.order_id)">
                                <i class="fas fa-times"></i> Hủy đơn hàng
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Xuất Hóa Đơn Modal -->
<div class="modal fade" id="xuatHoaDonModal" tabindex="-1" aria-labelledby="xuatHoaDonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="xuatHoaDonModalLabel">
                    <i class="fas fa-receipt"></i> Hoá đơn
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body" id="hoaDonModalBody">
                <!-- Nội dung hoá đơn sẽ được load bằng AJAX -->
                <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tải thông tin hoá đơn...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button type="button" class="btn btn-primary" onclick="printHoaDon()" id="printHoaDonBtn"
                    style="display: none;">
                    <i class="fas fa-print"></i> In hoá đơn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="cancelOrderModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Xác nhận hủy đơn hàng #@Model.order_id
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelOrderForm" method="post">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Lưu ý:</strong> Hành động này không thể hoàn tác. Đơn hàng sẽ được đánh dấu là "Đã hủy"
                        và không thể tiếp tục xử lý.
                    </div>

                    <p class="mb-3">Bạn có chắc chắn muốn hủy đơn hàng #@Model.order_id không?</p>

                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">
                            <i class="fas fa-comment"></i> Lý do hủy (tùy chọn)
                        </label>
                        <textarea class="form-control" id="cancelReason" name="reason" rows="3"
                            placeholder="Nhập lý do hủy đơn hàng (ví dụ: Khách hàng yêu cầu hủy, Hết nguyên liệu, v.v.)..."></textarea>
                        <div class="form-text">Lý do hủy sẽ được lưu trong lịch sử xử lý đơn hàng.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Không hủy
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban"></i> Xác nhận hủy đơn hàng
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showCancelModal(orderId) {
            const form = document.getElementById('cancelOrderForm');
            form.action = `/Order/Cancel/${orderId}`;

            // Clear previous reason
            document.getElementById('cancelReason').value = '';

            const modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
            modal.show();
        }

        // Handle form submission with AJAX
        document.getElementById('cancelOrderForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const form = this;
            const formData = new FormData(form);
            const orderId = form.action.split('/').pop();

            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
            submitBtn.disabled = true;

            // Send AJAX request
            fetch(`/Order/CancelAjax/${orderId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showAlert('success', data.message);

                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal'));
                        modal.hide();

                        // Redirect to AllOrders after a short delay
                        setTimeout(() => {
                            window.location.href = '/Order/AllOrders';
                        }, 1500);
                    } else {
                        // Show error message
                        showAlert('danger', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'Có lỗi xảy ra khi hủy đơn hàng.');
                })
                .finally(() => {
                    // Restore button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Function to show alerts
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                                                                        ${message}
                                                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                                                    `;

            // Insert at the top of the container
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Show temp data messages if any
        @if (TempData["SuccessMessage"] != null)
            {
                <text>
                    showAlert('success', '@Html.Raw(TempData["SuccessMessage"])');
                </text>
        }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                    showAlert('danger', '@Html.Raw(TempData["ErrorMessage"])');
                </text>
        }

            // Xuất hóa đơn modal functions
            function showXuatHoaDonModal(orderId) {
                const modal = new bootstrap.Modal(document.getElementById('xuatHoaDonModal'));
                modal.show();

                // Reset modal content
                document.getElementById('hoaDonModalBody').innerHTML = `
                                        <div class="text-center">
                                            <div class="spinner-border text-success" role="status">
                                                <span class="visually-hidden">Đang tải...</span>
                                            </div>
                                            <p class="mt-2">Đang tải thông tin hoá đơn...</p>
                                        </div>
                                    `;
                document.getElementById('printHoaDonBtn').style.display = 'none';

                // Load hóa đơn data
                loadHoaDonData(orderId);
            }

        function loadHoaDonData(orderId) {
            const formData = new FormData();
            formData.append('phuongThuc', 'Tiền mặt');

            fetch(`/Order/XuatHoaDonAjax/${orderId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayHoaDon(data.hoaDon, data.orderDetails, data.isExisting);
                        showAlert('success', data.message);
                    } else {
                        document.getElementById('hoaDonModalBody').innerHTML = `
                                                <div class="alert alert-danger">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    ${data.message}
                                                </div>
                                            `;
                        showAlert('danger', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('hoaDonModalBody').innerHTML = `
                                            <div class="alert alert-danger">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                Có lỗi xảy ra khi tải thông tin hoá đơn.
                                            </div>
                                        `;
                    showAlert('danger', 'Có lỗi xảy ra khi tải thông tin hoá đơn.');
                });
        }

        function displayHoaDon(hoaDon, orderDetails, isExisting) {
            const modalBody = document.getElementById('hoaDonModalBody');

            let orderItemsHtml = '';
            if (orderDetails.orderItems && orderDetails.orderItems.length > 0) {
                orderItemsHtml = `
                                        <h5><i class="fas fa-list"></i> Chi tiết món ăn</h5>
                                        <table class="items-table">
                                            <thead>
                                                <tr>
                                                    <th>STT</th>
                                                    <th>Tên món</th>
                                                    <th>Loại</th>
                                                    <th>Số lượng</th>
                                                    <th>Đơn giá</th>
                                                    <th>Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${orderDetails.orderItems.map((item, index) => `
                                                    <tr>
                                                        <td>${index + 1}</td>
                                                        <td><strong>${item.ten_mon}</strong></td>
                                                        <td><span class="badge bg-secondary">${item.loai_mon}</span></td>
                                                        <td>${item.so_luong}</td>
                                                        <td>${formatCurrency(item.gia)} VNĐ</td>
                                                        <td><strong>${formatCurrency(item.gia * item.so_luong)} VNĐ</strong></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    `;
            }

            modalBody.innerHTML = `
                        <div class="invoice-modal-content">
                            <div class="invoice-header">
                                <div class="invoice-title">HOÁ ĐƠN</div>
                                <div class="invoice-subtitle">RESTAURANT MANAGEMENT SYSTEM</div>
                            </div>
                    
                            <div class="invoice-body">
                                <div class="invoice-info">
                                    <div class="info-section">
                                        <h5><i class="fas fa-receipt"></i> Thông tin hoá đơn</h5>
                                        <div class="info-row">
                                            <span class="info-label">Mã hoá đơn:</span>
                                            <span class="info-value">#${hoaDon.hd_id}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Mã đơn hàng:</span>
                                            <span class="info-value">#${orderDetails.order_id}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Ngày xuất:</span>
                                            <span class="info-value">${formatDateTime(hoaDon.thoi_diem_tt)}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Phương thức:</span>
                                            <span class="info-value">${hoaDon.phuong_thuc || 'Tiền mặt'}</span>
                                        </div>
                                    </div>
                            
                                    <div class="info-section">
                                        <h5><i class="fas fa-user"></i> Thông tin khách hàng</h5>
                                        ${orderDetails.khach_hang_ten ? `
                                            <div class="info-row">
                                                <span class="info-label">Tên khách hàng:</span>
                                                <span class="info-value">${orderDetails.khach_hang_ten}</span>
                                            </div>
                                        ` : ''}
                                        ${orderDetails.khach_hang_sdt ? `
                                            <div class="info-row">
                                                <span class="info-label">Số điện thoại:</span>
                                                <span class="info-value">${orderDetails.khach_hang_sdt}</span>
                                            </div>
                                        ` : ''}
                                        <div class="info-row">
                                            <span class="info-label">Loại đơn:</span>
                                            <span class="info-value">
                                                <span class="badge ${orderDetails.la_mang_ve ? 'bg-info' : 'bg-success'}">
                                                    ${orderDetails.la_mang_ve ? 'Mang về' : 'Ăn tại chỗ'}
                                                </span>
                                            </span>
                                        </div>
                                        ${orderDetails.ban_so_hieu ? `
                                            <div class="info-row">
                                                <span class="info-label">Bàn:</span>
                                                <span class="info-value">Bàn ${orderDetails.ban_so_hieu}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                        
                                ${orderItemsHtml}
                        
                                <div class="total-section">
                                    <div class="total-row">
                                        <span class="total-label">TỔNG CỘNG:</span>
                                        <span class="total-amount">${formatCurrency(orderDetails.tong_tien)} VNĐ</span>
                                    </div>
                                </div>
                            </div>
                    
                            <div class="invoice-footer">
                                <p><strong>Cảm ơn quý khách đã sử dụng dịch vụ!</strong></p>
                                <p>Hoá đơn được tạo tự động bởi hệ thống quản lý nhà hàng</p>
                            </div>
                        </div>
                    `;

            document.getElementById('printHoaDonBtn').style.display = 'inline-block';
        }

        function printHoaDon() {
            const modalContent = document.querySelector('#hoaDonModalBody .invoice-modal-content');
            if (modalContent) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                                            <html>
                                                <head>
                                                    <title>Hoá đơn</title>
                                                    <style>
                                                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                                                        .invoice-modal-content { max-width: 800px; margin: 0 auto; }
                                                        ${document.querySelector('style').innerHTML}
                                                    </style>
                                                </head>
                                                <body>
                                                    ${modalContent.outerHTML}
                                                </body>
                                            </html>
                                        `);
                printWindow.document.close();
                printWindow.print();
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount || 0);
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
}

@functions {
    string GetStatusText(string status)
    {
        return status switch
        {
            "CHUA_HOAN_THANH" => "Chưa hoàn thành",
            "HOAN_THANH" => "Hoàn thành",
            "DA_HUY" => "Đã hủy",
            _ => status
        };
    }
}
