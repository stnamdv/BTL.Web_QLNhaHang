@model List<BTL.Web.Models.ThongKeMonAnTop>
@{
    ViewData["Title"] = "Top món ăn được đặt nhiều nhất";
    var thang = ViewBag.Thang ?? DateTime.Now.Month;
    var nam = ViewBag.Nam ?? DateTime.Now.Year;
    var topN = ViewBag.TopN ?? 10;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-trophy text-warning"></i> Top món ăn được đặt nhiều nhất</h2>
                <div class="btn-group">
                    <a asp-action="Index" asp-route-thang="@thang" asp-route-nam="@nam" class="btn btn-secondary">
                        <i class="fas fa-utensils"></i> Thống kê chính
                    </a>
                    <a asp-action="Dashboard" asp-route-thang="@thang" asp-route-nam="@nam" class="btn btn-info">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a asp-action="ChiTiet" asp-route-thang="@thang" asp-route-nam="@nam" class="btn btn-warning">
                        <i class="fas fa-list"></i> Chi tiết
                    </a>
                </div>
            </div>

            <!-- Form lọc dữ liệu -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Lọc dữ liệu</h5>
                </div>
                <div class="card-body">
                    <form asp-action="TopMonAn" method="post" class="row g-3">
                        <div class="col-md-3">
                            <label for="Thang" class="form-label">Tháng</label>
                            <select name="Thang" id="Thang" class="form-select" required>
                                @for (int i = 1; i <= 12; i++)
                                {
                                        if (i == thang)
                                        {
                                                <option value="@i" selected>Tháng @i</option>
                                        }
                                        else
                                        {
                                                <option value="@i">Tháng @i</option>
                                        }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="Nam" class="form-label">Năm</label>
                            <select name="Nam" id="Nam" class="form-select" required>
                                @for (int i = DateTime.Now.Year - 5; i <= DateTime.Now.Year + 1; i++)
                                {
                                        if (i == nam)
                                        {
                                                <option value="@i" selected>@i</option>
                                        }
                                        else
                                        {
                                                <option value="@i">@i</option>
                                        }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="TopN" class="form-label">Số lượng top</label>
                            <select name="TopN" id="TopN" class="form-select" required>
                                @for (int i = 5; i <= 50; i += 5)
                                {
                                        if (i == topN)
                                        {
                                                <option value="@i" selected>Top @i</option>
                                        }
                                        else
                                        {
                                                <option value="@i">Top @i</option>
                                        }
                                }
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Xem top món ăn
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Thông tin tháng được chọn -->
            <div class="alert alert-warning">
                <h5><i class="fas fa-crown"></i> Top @topN món ăn được đặt nhiều nhất tháng @thang/@nam</h5>
                <p class="mb-0">Danh sách các món ăn được khách hàng đặt nhiều nhất trong tháng</p>
            </div>

            @if (Model.Any())
            {
                    <!-- Bảng top món ăn -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-trophy"></i> Bảng xếp hạng</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="topMonAnTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Xếp hạng</th>
                                            <th>Tên món</th>
                                            <th>Loại món</th>
                                            <th>Giá (VNĐ)</th>
                                            <th>Số lần được đặt</th>
                                            <th>Tổng số lượng</th>
                                            <th>Số đơn chứa món</th>
                                            <th>Tổng doanh thu</th>
                                            <th>TB số lượng/lần</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model)
                                        {
                                                <tr class="@(item.xep_hang_so_lan_dat <= 3 ? "table-warning" : "")">
                                                    <td>
                                                        @if (item.xep_hang_so_lan_dat == 1)
                                                        {
                                                                <i class="fas fa-crown fa-2x text-warning"></i>
                                                        }
                                                        else if (item.xep_hang_so_lan_dat == 2)
                                                        {
                                                                <i class="fas fa-medal fa-2x text-secondary"></i>
                                                        }
                                                        else if (item.xep_hang_so_lan_dat == 3)
                                                        {
                                                                <i class="fas fa-award fa-2x text-warning"></i>
                                                        }
                                                        else
                                                        {
                                                                <span class="badge bg-primary fs-6">#@item.xep_hang_so_lan_dat</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <strong>@item.ten_mon</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info">@item.loai_mon</span>
                                                    </td>
                                                    <td>@item.gia.ToString("N0")</td>
                                                    <td>
                                                        <span class="badge bg-success fs-6">@item.so_lan_duoc_dat</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-warning">@item.tong_so_luong_dat</span>
                                                    </td>
                                                    <td>@item.so_don_hang_chua_mon</td>
                                                    <td>
                                                        <span class="badge bg-danger">@item.tong_doanh_thu_mon.ToString("N0")</span>
                                                    </td>
                                                    <td>@item.trung_binh_so_luong_moi_lan.ToString("F2")</td>
                                                </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Biểu đồ top món ăn -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Biểu đồ top món ăn</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="topMonAnChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Phân bố doanh thu</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="doanhThuChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thống kê tổng hợp -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Tổng số món</h5>
                                    <h3>@Model.Count</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Tổng lần đặt</h5>
                                    <h3>@Model.Sum(x => x.so_lan_duoc_dat)</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Tổng số lượng</h5>
                                    <h3>@Model.Sum(x => x.tong_so_luong_dat)</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Tổng doanh thu</h5>
                                    <h3>@Model.Sum(x => x.tong_doanh_thu_mon).ToString("N0")</h3>
                                </div>
                            </div>
                        </div>
                    </div>
            }
            else
            {
                    <div class="alert alert-warning text-center">
                        <h5><i class="fas fa-exclamation-triangle"></i> Không có dữ liệu</h5>
                        <p>Không tìm thấy dữ liệu top món ăn cho tháng @thang/@nam</p>
                    </div>
            }
        </div>
    </div>
</div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            $(document).ready(function() {
                // Khởi tạo DataTable
                $('#topMonAnTable').DataTable({
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json"
                    },
                    "pageLength": 25,
                    "order": [[ 0, "asc" ]]
                });

                // Dữ liệu cho biểu đồ
                const topMonAnData = @Html.Raw(Json.Serialize(Model));
            
                if (topMonAnData.length > 0) {
                    // Biểu đồ cột - Top món ăn
                    const topMonAnCtx = document.getElementById('topMonAnChart').getContext('2d');
                    new Chart(topMonAnCtx, {
                        type: 'bar',
                        data: {
                            labels: topMonAnData.map(item => item.ten_mon),
                            datasets: [{
                                label: 'Số lần được đặt',
                                data: topMonAnData.map(item => item.so_lan_duoc_dat),
                                backgroundColor: topMonAnData.map((item, index) => {
                                    if (index === 0) return '#FFD700'; // Vàng cho hạng 1
                                    if (index === 1) return '#C0C0C0'; // Bạc cho hạng 2
                                    if (index === 2) return '#CD7F32'; // Đồng cho hạng 3
                                    return '#36A2EB'; // Xanh cho các hạng khác
                                }),
                                borderColor: topMonAnData.map((item, index) => {
                                    if (index === 0) return '#FFA500';
                                    if (index === 1) return '#808080';
                                    if (index === 2) return '#B87333';
                                    return '#1E7E34';
                                }),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });

                    // Biểu đồ tròn - Phân bố doanh thu
                    const doanhThuCtx = document.getElementById('doanhThuChart').getContext('2d');
                    new Chart(doanhThuCtx, {
                        type: 'doughnut',
                        data: {
                            labels: topMonAnData.map(item => item.ten_mon),
                            datasets: [{
                                data: topMonAnData.map(item => item.tong_doanh_thu_mon),
                                backgroundColor: [
                                    '#FFD700', '#C0C0C0', '#CD7F32', '#36A2EB', '#FF6384',
                                    '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            });
        </script>
}
