@model BTL.Web.Models.TanSuatDatBanSearchModel
@{
    ViewData["Title"] = "Tần suất đặt bàn";
}


    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">



    <!-- jQuery (load first) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar"></i> Tần suất đặt bàn theo sức chứa
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Form tìm kiếm -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <form asp-action="Index" method="post" class="form-inline">
                                <div class="form-group me-3">
                                    <label class="form-label me-2">Sức chứa:</label>
                                    <select asp-for="SucChua" class="form-control" style="min-width: 200px;">
                                        <option value="">-- Tất cả sức chứa --</option>
                                        @if (ViewBag.DanhSachLoaiBan != null)
                                        {
                                            @foreach (var loaiBan in ViewBag.DanhSachLoaiBan)
                                            {
                                                <option value="@loaiBan.suc_chua">@loaiBan.suc_chua người (SL: @loaiBan.so_luong)</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="form-group me-3">
                                    <label class="form-label me-2">Ngày trong tháng:</label>
                                    <select asp-for="NgayTrongThang" class="form-control">
                                        <option value="">-- Tất cả ngày --</option>
                                        @for (int i = 1; i <= 31; i++)
                                        {
                                            <option value="@i">Ngày @i</option>
                                        }
                                    </select>
                                </div>

                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Thống kê
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Thông báo lỗi -->
                    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
                    {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>@ViewBag.ErrorMessage
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                    }

                    <!-- Thông báo thành công -->
                    @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
                    {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2"></i>@ViewBag.SuccessMessage
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                    }

                    <!-- Thông tin stored procedure -->
                    @if (!string.IsNullOrEmpty(ViewBag.StoredProcedure))
                    {
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-database"></i> Thông tin Stored Procedure
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Tên SP:</strong> @ViewBag.StoredProcedure
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Mô tả:</strong> @ViewBag.StoredProcedureDescription
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Thời gian thực thi:</strong> @ViewBag.ExecutionTime
                                        </div>
                                    </div>
                                </div>
                            </div>
                    }

                    <!-- Biểu đồ -->
                    @if (ViewBag.TanSuatDatBan != null)
                    {
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">
                                                <i class="fas fa-chart-line"></i> Biểu đồ tần suất đặt bàn
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="tanSuatDatBanChart" width="400" height="500"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    }

                    <!-- Bảng dữ liệu -->
                    @if (ViewBag.TanSuatDatBan != null)
                    {
                            var tanSuatDatBan = ViewBag.TanSuatDatBan as List<BTL.Web.Models.TanSuatDatBan>;
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">
                                                <i class="fas fa-table"></i> Dữ liệu tần suất đặt bàn
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table id="tanSuatDatBanTable" class="table table-striped table-bordered">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>Ngày trong tháng</th>
                                                            <th>Sức chứa</th>
                                                            <th>Trung bình/ngày</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var item in tanSuatDatBan)
                                                        {
                                                                <tr>
                                                                    <td>@item.ngay_trong_thang</td>
                                                                    <td><strong>@item.suc_chua người</strong></td>
                                                                    <td class="text-end">
                                                                        <span class="badge bg-primary">@item.trung_binh_ngay.ToString("F2")</span>
                                                                    </td>
                                                                </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function () {
        // Kiểm tra DataTable đã load chưa
        if (typeof $.fn.DataTable !== 'undefined') {
            // Khởi tạo DataTable
            $('#tanSuatDatBanTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json"
                },
                "pageLength": 25,
                "order": [[0, "asc"]], // Sắp xếp theo ngày tăng dần
                "columnDefs": [
                    { "orderable": false, "targets": [] }
                ]
            });
        } else {
            console.error('DataTable library not loaded');
        }

        // Tạo biểu đồ
        @if (ViewBag.TanSuatDatBan != null)
        {
                var tanSuatDatBan = ViewBag.TanSuatDatBan as List<BTL.Web.Models.TanSuatDatBan>;
                <text>
                    // Kiểm tra Chart.js đã load chưa
                    if (typeof Chart !== 'undefined') {
                        var tanSuatData = @Html.Raw(Json.Serialize(tanSuatDatBan));

                        // Nhóm dữ liệu theo ngày
                        var groupedData = {};
                        tanSuatData.forEach(function(item) {
                            var ngay = item.ngay_trong_thang;
                            if (!groupedData[ngay]) {
                                groupedData[ngay] = {};
                            }
                            groupedData[ngay][item.suc_chua + ' người'] = item.trung_binh_ngay;
                        });

                        // Chuẩn bị dữ liệu cho Chart.js
                        var labels = Object.keys(groupedData).sort((a, b) => parseInt(a) - parseInt(b));
                        var datasets = [];
                        var colors = [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                        ];

                        // Lấy danh sách tất cả sức chứa
                        var allSucChua = [...new Set(tanSuatData.map(item => item.suc_chua + ' người'))];

                        allSucChua.forEach(function(sucChua, index) {
                            var data = labels.map(function(label) {
                                return groupedData[label][sucChua] || 0;
                            });

                            datasets.push({
                                label: sucChua,
                                data: data,
                                borderColor: colors[index % colors.length],
                                backgroundColor: colors[index % colors.length] + '20',
                                borderWidth: 2,
                                fill: false
                            });
                        });

                        // Vẽ biểu đồ
                        var ctx = document.getElementById('tanSuatDatBanChart').getContext('2d');
                        var tanSuatDatBanChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Số lượng đặt bàn trung bình'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Ngày trong tháng'
                                        }
                                    }
                                },
                                plugins: {
                                title: {
                                    display: true,
                                    text: 'Tần suất đặt bàn theo sức chứa'
                                },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                }
                            }
                        });
                    } else {
                        console.error('Chart.js library not loaded');
                    }
                </text>
        }
    });
    </script>
}
