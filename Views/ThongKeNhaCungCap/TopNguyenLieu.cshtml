@model List<BTL.Web.Models.TopNguyenLieuNhaCungCap>
@{
    ViewData["Title"] = "Top Nguy√™n li·ªáu Nh√† cung c·∫•p";
    var danhSachNhaCungCap = ViewBag.DanhSachNhaCungCap as List<BTL.Web.Models.NhaCungCap>;
    var thangHienTai = ViewBag.ThangHienTai as int? ?? DateTime.Now.Month;
    var namHienTai = ViewBag.NamHienTai as int? ?? DateTime.Now.Year;
    var topNHienTai = ViewBag.TopNHienTai as int? ?? 5;
    var nccIdSelected = ViewBag.NccIdSelected as int?;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-trophy"></i>
                        Top Nguy√™n li·ªáu ƒë∆∞·ª£c s·ª≠ d·ª•ng nhi·ªÅu nh·∫•t c·ªßa Nh√† cung c·∫•p
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Form l·ªçc d·ªØ li·ªáu -->
                    <form asp-action="TopNguyenLieu" method="post" class="mb-4">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="Thang">Th√°ng:</label>
                                    <select name="Thang" id="Thang" class="form-control">
                                        @for (int i = 1; i <= 12; i++)
                                        {
                                                            <option value="@i" selected="@(i == thangHienTai)">Th√°ng @i</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="Nam">NƒÉm:</label>
                                    <select name="Nam" id="Nam" class="form-control">
                                        @for (int i = DateTime.Now.Year - 2; i <= DateTime.Now.Year + 1; i++)
                                        {
                                                            <option value="@i" selected="@(i == namHienTai)">@i</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="TopN">Top N:</label>
                                    <select name="TopN" id="TopN" class="form-control">
                                        @for (int i = 3; i <= 20; i++)
                                        {
                                                            <option value="@i" selected="@(i == topNHienTai)">Top @i</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="NccId">Nh√† cung c·∫•p:</label>
                                    <select name="NccId" id="NccId" class="form-control">
                                        <option value="">-- T·∫•t c·∫£ nh√† cung c·∫•p --</option>
                                        @if (danhSachNhaCungCap != null)
                                        {
                                                            @foreach (var ncc in danhSachNhaCungCap)
                                                            {
                                                                                <option value="@ncc.ncc_id" selected="@(ncc.ncc_id == nccIdSelected)">@ncc.ten</option>
                                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fas fa-search"></i> L·ªçc
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Th√¥ng b√°o l·ªói -->
                    @if (TempData["ErrorMessage"] != null)
                    {
                                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            @TempData["ErrorMessage"]
                                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                    }

                    <!-- B·∫£ng top nguy√™n li·ªáu -->
                    @if (Model != null && Model.Any())
                    {
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-striped table-hover">
                                                <thead class="thead-dark">
                                                    <tr>
                                                        <th>H·∫°ng</th>
                                                        <th>Nh√† cung c·∫•p</th>
                                                        <th>Nguy√™n li·ªáu</th>
                                                        <th>ƒê∆°n v·ªã</th>
                                                        <th>Gi√° nh·∫≠p (VNƒê)</th>
                                                        <th>L∆∞·ª£ng s·ª≠ d·ª•ng (kg)</th>
                                                        <th>Gi√° tr·ªã s·ª≠ d·ª•ng (VNƒê)</th>
                                                        <th>S·ªë m√≥n s·ª≠ d·ª•ng</th>
                                                        <th>S·ªë ƒë∆°n h√†ng</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                                        string currentNcc = "";
                                                                        int currentRank = 1;
                                                    }
                                                    @foreach (var item in Model)
                                                    {
                                                                        @if (currentNcc != item.ten_nha_cung_cap)
                                                                        {
                                                                                            currentNcc = item.ten_nha_cung_cap;
                                                                                            currentRank = 1;
                                                                        }
                                        
                                                                        <tr>
                                                                            <td>
                                                                                @if (currentRank == 1)
                                                                                {
                                                                                                    <span class="badge badge-warning">ü•á</span>
                                                                                }
                                                                                else if (currentRank == 2)
                                                                                {
                                                                                                    <span class="badge badge-secondary">ü•à</span>
                                                                                }
                                                                                else if (currentRank == 3)
                                                                                {
                                                                                                    <span class="badge badge-warning">ü•â</span>
                                                                                }
                                                                                else
                                                                                {
                                                                                                    <span class="badge badge-info">@currentRank</span>
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                <strong>@item.ten_nha_cung_cap</strong>
                                                                            </td>
                                                                            <td>
                                                                                <strong>@item.ten_nguyen_lieu</strong>
                                                                            </td>
                                                                            <td>
                                                                                <span class="badge badge-secondary">@item.don_vi</span>
                                                                            </td>
                                                                            <td>
                                                                                <span class="text-primary font-weight-bold">
                                                                                    @item.gia_nhap.ToString("N0") VNƒê
                                                                                </span>
                                                                            </td>
                                                                            <td>
                                                                                <span class="text-success font-weight-bold">
                                                                                    @item.luong_su_dung.ToString("N2") kg
                                                                                </span>
                                                                            </td>
                                                                            <td>
                                                                                <span class="text-warning font-weight-bold">
                                                                                    @item.gia_tri_su_dung.ToString("N0") VNƒê
                                                                                </span>
                                                                            </td>
                                                                            <td>
                                                                                <span class="badge badge-info">@item.so_mon_su_dung</span>
                                                                            </td>
                                                                            <td>
                                                                                <span class="badge badge-warning">@item.so_don_hang</span>
                                                                            </td>
                                                                        </tr>
                                                                        currentRank++;
                                                    }
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- Th·ªëng k√™ theo nh√† cung c·∫•p -->
                                        <div class="row mt-4">
                                            <div class="col-md-12">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h5 class="card-title">
                                                            <i class="fas fa-chart-pie"></i>
                                                            Th·ªëng k√™ theo Nh√† cung c·∫•p - Th√°ng @thangHienTai/@namHienTai
                                                        </h5>
                                                        <div class="row">
                                                            @{
                                                                                var groupedByNcc = Model.GroupBy(x => x.ten_nha_cung_cap).ToList();
                                                            }
                                                            @foreach (var group in groupedByNcc)
                                                            {
                                                                                <div class="col-md-6 col-lg-4 mb-3">
                                                                                    <div class="card">
                                                                                        <div class="card-header">
                                                                                            <h6 class="card-title mb-0">
                                                                                                <i class="fas fa-building"></i>
                                                                                                @group.Key
                                                                                            </h6>
                                                                                        </div>
                                                                                        <div class="card-body">
                                                                                            <div class="row">
                                                                                                <div class="col-6">
                                                                                                    <small class="text-muted">S·ªë NL:</small><br>
                                                                                                    <span class="badge badge-info">@group.Count()</span>
                                                                                                </div>
                                                                                                <div class="col-6">
                                                                                                    <small class="text-muted">T·ªïng l∆∞·ª£ng:</small><br>
                                                                                                    <span class="text-primary">@group.Sum(x => x.luong_su_dung).ToString("N2")</span>
                                                                                                </div>
                                                                                                <div class="col-6 mt-2">
                                                                                                    <small class="text-muted">T·ªïng gi√° tr·ªã:</small><br>
                                                                                                    <span class="text-success">@group.Sum(x => x.gia_tri_su_dung).ToString("C0")</span>
                                                                                                </div>
                                                                                                <div class="col-6 mt-2">
                                                                                                    <small class="text-muted">T·ªïng ƒë∆°n h√†ng:</small><br>
                                                                                                    <span class="badge badge-warning">@group.Sum(x => x.so_don_hang)</span>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- T·ªïng k·∫øt -->
                                        <div class="row mt-4">
                                            <div class="col-md-12">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h5 class="card-title">
                                                            <i class="fas fa-chart-bar"></i>
                                                            T·ªïng k·∫øt Top @topNHienTai nguy√™n li·ªáu
                                                        </h5>
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <div class="info-box">
                                                                    <span class="info-box-icon bg-info">
                                                                        <i class="fas fa-building"></i>
                                                                    </span>
                                                                    <div class="info-box-content">
                                                                        <span class="info-box-text">T·ªïng NCC</span>
                                                                        <span class="info-box-number">@groupedByNcc.Count</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="info-box">
                                                                    <span class="info-box-icon bg-success">
                                                                        <i class="fas fa-boxes"></i>
                                                                    </span>
                                                                    <div class="info-box-content">
                                                                        <span class="info-box-text">T·ªïng NL</span>
                                                                        <span class="info-box-number">@Model.Count</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="info-box">
                                                                    <span class="info-box-icon bg-warning">
                                                                        <i class="fas fa-weight"></i>
                                                                    </span>
                                                                    <div class="info-box-content">
                                                                        <span class="info-box-text">T·ªïng l∆∞·ª£ng</span>
                                                                        <span class="info-box-number">@Model.Sum(x => x.luong_su_dung).ToString("N2")</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="info-box">
                                                                    <span class="info-box-icon bg-primary">
                                                                        <i class="fas fa-dollar-sign"></i>
                                                                    </span>
                                                                    <div class="info-box-content">
                                                                        <span class="info-box-text">T·ªïng gi√° tr·ªã</span>
                                                                        <span class="info-box-number">@Model.Sum(x => x.gia_tri_su_dung).ToString("C0")</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                    }
                    else
                    {
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            Kh√¥ng c√≥ d·ªØ li·ªáu top nguy√™n li·ªáu cho th√°ng @thangHienTai/@namHienTai
                                        </div>
                    }
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <a href="@Url.Action("Index")" class="btn btn-primary">
                                <i class="fas fa-list"></i> Danh s√°ch chi ti·∫øt
                            </a>
                            <a href="@Url.Action("Dashboard")" class="btn btn-success">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                            <a href="@Url.Action("SoSanh")" class="btn btn-warning">
                                <i class="fas fa-balance-scale"></i> So s√°nh th√°ng
                            </a>
                        </div>
                        <div class="col-md-6 text-right">
                            <small class="text-muted">
                                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
                    <script>
                        $(document).ready(function() {
                            // Kh·ªüi t·∫°o DataTable
                            $('.table').DataTable({
                                "language": {
                                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json"
                                },
                                "pageLength": 25,
                                "order": [[5, "desc"]], // S·∫Øp x·∫øp theo l∆∞·ª£ng s·ª≠ d·ª•ng gi·∫£m d·∫ßn
                                "columnDefs": [
                                    { "orderable": false, "targets": 0 } // C·ªôt h·∫°ng kh√¥ng s·∫Øp x·∫øp
                                ]
                            });
                        });
                    </script>
}
