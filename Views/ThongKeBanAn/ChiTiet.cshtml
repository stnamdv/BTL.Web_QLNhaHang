@model List<BTL.Web.Models.ThongKeBanAnChiTiet>
@{
    ViewData["Title"] = "Chi tiết thống kê bàn ăn";
    var thang = ViewBag.Thang ?? DateTime.Now.Month;
    var nam = ViewBag.Nam ?? DateTime.Now.Year;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list text-primary"></i> Chi tiết thống kê bàn ăn</h2>
                <div class="btn-group">
                    <a asp-action="Index" asp-route-thang="@thang" asp-route-nam="@nam" class="btn btn-secondary">
                        <i class="fas fa-chart-bar"></i> Thống kê chính
                    </a>
                    <a asp-action="Dashboard" asp-route-thang="@thang" asp-route-nam="@nam" class="btn btn-info">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a asp-action="TongHop" asp-route-thang="@thang" asp-route-nam="@nam" class="btn btn-success">
                        <i class="fas fa-chart-pie"></i> Tổng hợp
                    </a>
                </div>
            </div>

            <!-- Thông tin tháng -->
            <div class="alert alert-info">
                <h5><i class="fas fa-calendar-alt"></i> Chi tiết thống kê tháng @thang/@nam</h5>
                <p class="mb-0">Dữ liệu chi tiết theo từng ngày trong tháng</p>
            </div>

            @if (Model.Any())
            {
                        <!-- Bảng chi tiết -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-table"></i> Dữ liệu chi tiết</h5>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel"></i> Xuất Excel
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="chiTietTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Ngày</th>
                                                <th>Loại bàn</th>
                                                <th>Số bàn sử dụng</th>
                                                <th>Số lần đặt bàn</th>
                                                <th>Tổng số khách</th>
                                                <th>Tỷ lệ sử dụng (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model)
                                            {
                                                        <tr>
                                                            <td>
                                                                <span class="badge bg-info">@item.ngay.ToString("dd/MM/yyyy")</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-primary">@item.ten_loai_ban</span>
                                                            </td>
                                                            <td>@item.so_ban_su_dung</td>
                                                            <td>@item.so_lan_dat_ban</td>
                                                            <td>@item.tong_so_khach</td>
                                                            <td>
                                                                <div class="progress" style="height: 20px;">
                                                                    <div class="progress-bar @(item.ty_le_su_dung_ngay > 70 ? "bg-success" : item.ty_le_su_dung_ngay > 40 ? "bg-warning" : "bg-danger")" 
                                                                         role="progressbar" 
                                                                         style="width: @(Math.Min(item.ty_le_su_dung_ngay, 100))%"
                                                                         aria-valuenow="@item.ty_le_su_dung_ngay" 
                                                                         aria-valuemin="0" 
                                                                         aria-valuemax="100">
                                                                        @item.ty_le_su_dung_ngay.ToString("F1")%
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Biểu đồ chi tiết -->
                        <div class="row mt-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Biểu đồ xu hướng theo ngày</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="trendChart" height="100"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Phân bố theo loại bàn</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="distributionChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thống kê tổng hợp -->
                        <div class="row mt-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Tổng ngày có dữ liệu</h5>
                                        <h3>@Model.Select(x => x.ngay).Distinct().Count()</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Tổng bàn sử dụng</h5>
                                        <h3>@Model.Sum(x => x.so_ban_su_dung)</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Tổng đơn hàng</h5>
                                        <h3>@Model.Sum(x => x.so_lan_dat_ban)</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Tổng khách hàng</h5>
                                        <h3>@Model.Sum(x => x.tong_so_khach)</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
            }
            else
            {
                        <div class="alert alert-warning text-center">
                            <h5><i class="fas fa-exclamation-triangle"></i> Không có dữ liệu</h5>
                            <p>Không tìm thấy dữ liệu chi tiết cho tháng @thang/@nam</p>
                        </div>
            }
        </div>
    </div>
</div>

@section Scripts {
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                function exportToExcel() {
                    const thang = @thang;
                    const nam = @nam;
            
                    fetch(`/ThongKeBanAn/ExportExcel?thang=${thang}&nam=${nam}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Xuất Excel thành công!');
                            } else {
                                alert('Lỗi: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Có lỗi xảy ra khi xuất Excel');
                        });
                }

                $(document).ready(function() {
                    // Khởi tạo DataTable
                    $('#chiTietTable').DataTable({
                        "language": {
                            "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json"
                        },
                        "pageLength": 25,
                        "order": [[ 0, "desc" ], [ 1, "asc" ]]
                    });

                    // Dữ liệu cho biểu đồ
                    const chiTietData = @Html.Raw(Json.Serialize(Model));
            
                    if (chiTietData.length > 0) {
                        // Biểu đồ xu hướng
                        const trendCtx = document.getElementById('trendChart').getContext('2d');
                
                        // Nhóm dữ liệu theo ngày
                        const groupedByDate = {};
                        chiTietData.forEach(item => {
                            const date = new Date(item.ngay).toLocaleDateString('vi-VN');
                            if (!groupedByDate[date]) {
                                groupedByDate[date] = {
                                    date: date,
                                    totalBan: 0,
                                    totalDon: 0,
                                    totalKhach: 0
                                };
                            }
                            groupedByDate[date].totalBan += item.so_ban_su_dung;
                            groupedByDate[date].totalDon += item.so_lan_dat_ban;
                            groupedByDate[date].totalKhach += item.tong_so_khach;
                        });
                
                        const dates = Object.keys(groupedByDate).sort();
                        const banData = dates.map(date => groupedByDate[date].totalBan);
                        const donData = dates.map(date => groupedByDate[date].totalDon);
                        const khachData = dates.map(date => groupedByDate[date].totalKhach);
                
                        new Chart(trendCtx, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: 'Số bàn sử dụng',
                                    data: banData,
                                    borderColor: '#36A2EB',
                                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                    tension: 0.4
                                }, {
                                    label: 'Số đơn hàng',
                                    data: donData,
                                    borderColor: '#FF6384',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    tension: 0.4
                                }, {
                                    label: 'Số khách hàng',
                                    data: khachData,
                                    borderColor: '#4BC0C0',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        // Biểu đồ phân bố theo loại bàn
                        const distributionCtx = document.getElementById('distributionChart').getContext('2d');
                
                        const banTypes = {};
                        chiTietData.forEach(item => {
                            if (!banTypes[item.ten_loai_ban]) {
                                banTypes[item.ten_loai_ban] = 0;
                            }
                            banTypes[item.ten_loai_ban] += item.so_ban_su_dung;
                        });
                
                        new Chart(distributionCtx, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(banTypes),
                                datasets: [{
                                    data: Object.values(banTypes),
                                    backgroundColor: [
                                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                });
            </script>
}
