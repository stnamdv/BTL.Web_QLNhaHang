@model BTL.Web.Models.ThongKeBanAnSoSanhRequest
@{
    ViewData["Title"] = "So sánh thống kê bàn ăn";
    var soSanh = ViewBag.SoSanh as List<BTL.Web.Models.ThongKeBanAnSoSanh> ?? new List<BTL.Web.Models.ThongKeBanAnSoSanh>();
    var thang1 = ViewBag.Thang1;
    var nam1 = ViewBag.Nam1;
    var thang2 = ViewBag.Thang2;
    var nam2 = ViewBag.Nam2;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-balance-scale text-primary"></i> So sánh thống kê bàn ăn</h2>
                <div class="btn-group">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-chart-bar"></i> Thống kê chính
                    </a>
                    <a asp-action="Dashboard" class="btn btn-info">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </div>
            </div>

            <!-- Form so sánh -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Chọn tháng so sánh</h5>
                </div>
                <div class="card-body">
                    <form asp-action="SoSanh" method="post" class="row g-3">
                        <div class="col-md-6">
                            <h6 class="text-primary">Tháng 1</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="Thang1" class="form-label">Tháng</label>
                                    <select asp-for="Thang1" class="form-select" required>
                                        @for (int i = 1; i <= 12; i++)
                                        {
                                                <option value="@i">Tháng @i</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="Nam1" class="form-label">Năm</label>
                                    <select asp-for="Nam1" class="form-select" required>
                                        @for (int i = DateTime.Now.Year - 5; i <= DateTime.Now.Year + 1; i++)
                                        {
                                                <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Tháng 2</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="Thang2" class="form-label">Tháng</label>
                                    <select asp-for="Thang2" class="form-select" required>
                                        @for (int i = 1; i <= 12; i++)
                                        {
                                                <option value="@i">Tháng @i</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="Nam2" class="form-label">Năm</label>
                                    <select asp-for="Nam2" class="form-select" required>
                                        @for (int i = DateTime.Now.Year - 5; i <= DateTime.Now.Year + 1; i++)
                                        {
                                                <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> So sánh
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            @if (soSanh.Any())
            {
                    <!-- Thông tin so sánh -->
                    <div class="alert alert-info">
                        <h5><i class="fas fa-calendar-alt"></i> So sánh tháng @thang1/@nam1 với tháng @thang2/@nam2</h5>
                        <p class="mb-0">Phân tích sự thay đổi trong việc sử dụng bàn ăn giữa hai tháng</p>
                    </div>

                    <!-- Bảng so sánh -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-table"></i> Kết quả so sánh</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="soSanhTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th rowspan="2">Loại bàn</th>
                                            <th colspan="4" class="text-center text-primary">Tháng @thang1/@nam1</th>
                                            <th colspan="4" class="text-center text-success">Tháng @thang2/@nam2</th>
                                            <th colspan="3" class="text-center text-warning">So sánh</th>
                                        </tr>
                                        <tr>
                                            <th class="text-primary">Bàn sử dụng</th>
                                            <th class="text-primary">Đơn hàng</th>
                                            <th class="text-primary">Khách hàng</th>
                                            <th class="text-primary">TB khách/đơn</th>
                                            <th class="text-success">Bàn sử dụng</th>
                                            <th class="text-success">Đơn hàng</th>
                                            <th class="text-success">Khách hàng</th>
                                            <th class="text-success">TB khách/đơn</th>
                                            <th class="text-warning">Chênh lệch bàn</th>
                                            <th class="text-warning">Chênh lệch đơn</th>
                                            <th class="text-warning">% thay đổi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in soSanh)
                                        {
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-primary">@item.ten_loai_ban</span>
                                                    </td>
                                                    <!-- Tháng 1 -->
                                                    <td class="text-primary">@item.thang1_so_ban_su_dung</td>
                                                    <td class="text-primary">@item.thang1_so_don_hang</td>
                                                    <td class="text-primary">@item.thang1_tong_khach</td>
                                                    <td class="text-primary">@item.thang1_trung_binh_khach_don.ToString("F2")</td>
                                                    <!-- Tháng 2 -->
                                                    <td class="text-success">@item.thang2_so_ban_su_dung</td>
                                                    <td class="text-success">@item.thang2_so_don_hang</td>
                                                    <td class="text-success">@item.thang2_tong_khach</td>
                                                    <td class="text-success">@item.thang2_trung_binh_khach_don.ToString("F2")</td>
                                                    <!-- So sánh -->
                                                    <td>
                                                        <span
                                                            class="badge @(item.chenh_lech_ban_su_dung > 0 ? "bg-success" : item.chenh_lech_ban_su_dung < 0 ? "bg-danger" : "bg-secondary")">
                                                            @(item.chenh_lech_ban_su_dung > 0 ? "+" : "")@item.chenh_lech_ban_su_dung
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span
                                                            class="badge @(item.chenh_lech_don_hang > 0 ? "bg-success" : item.chenh_lech_don_hang < 0 ? "bg-danger" : "bg-secondary")">
                                                            @(item.chenh_lech_don_hang > 0 ? "+" : "")@item.chenh_lech_don_hang
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span
                                                            class="badge @(item.ty_le_thay_doi_ban_su_dung > 0 ? "bg-success" : item.ty_le_thay_doi_ban_su_dung < 0 ? "bg-danger" : "bg-secondary")">
                                                            @(item.ty_le_thay_doi_ban_su_dung > 0 ? "+" :
                                                                                                                                                                                                        "")@item.ty_le_thay_doi_ban_su_dung.ToString("F1") %
                                                </span>
                                            </td>
                                        </tr>
                                                                                                                                }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Tổng kết so sánh -->
                            <div class="row mt-4">
                                <div class="col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Tổng chênh lệch bàn</h5>
                                            <h3>@soSanh.Sum(x => x.chenh_lech_ban_su_dung)</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Tổng chênh lệch đơn</h5>
                                            <h3>@soSanh.Sum(x => x.chenh_lech_don_hang)</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Tổng chênh lệch khách</h5>
                                            <h3>@soSanh.Sum(x => x.chenh_lech_tong_khach)</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Biểu đồ so sánh -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Biểu đồ so sánh</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="comparisonChart" height="100"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            }
            else if (thang1 != null && nam1 != null && thang2 != null && nam2 != null)
            {
                    <div class="alert alert-warning text-center">
                        <h5><i class="fas fa-exclamation-triangle"></i> Không có dữ liệu</h5>
                        <p>Không tìm thấy dữ liệu để so sánh giữa tháng @thang1/@nam1 và tháng @thang2/@nam2</p>
                    </div>
            }
        </div>
    </div>
</div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            $(document).ready(function () {
                // Khởi tạo DataTable
                $('#soSanhTable').DataTable({
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json"
                    },
                    "pageLength": 10,
                    "order": [[0, "asc"]]
                });

                // Biểu đồ so sánh
                @if (soSanh.Any())
                    {
                            <text>
                                const soSanhData = @Html.Raw(Json.Serialize(soSanh));
                                const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');

                                new Chart(comparisonCtx, {
                                    type: 'bar',
                                data: {
                                    labels: soSanhData.map(item => item.ten_loai_ban),
                                datasets: [{
                                    label: 'Tháng @thang1/@nam1',
                                            data: soSanhData.map(item => item.thang1_so_ban_su_dung),
                                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                                        }, {
                                    label: 'Tháng @thang2/@nam2',
                                            data: soSanhData.map(item => item.thang2_so_ban_su_dung),
                                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                                        }]
                                    },
                                options: {
                                    responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                    beginAtZero: true
                                            }
                                        }
                                    }
                                });
                            </text>
                }
                });
        </script>
}
