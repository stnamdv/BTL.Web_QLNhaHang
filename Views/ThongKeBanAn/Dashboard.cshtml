@model BTL.Web.Models.ThongKeBanAnDashboard
@{
    ViewData["Title"] = "Dashboard thống kê bàn ăn";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tachometer-alt text-primary"></i> Dashboard thống kê bàn ăn</h2>
                <div class="btn-group">
                    <a asp-action="Index" asp-route-thang="@Model.Thang" asp-route-nam="@Model.Nam"
                        class="btn btn-secondary">
                        <i class="fas fa-chart-bar"></i> Thống kê chính
                    </a>
                    <a asp-action="ChiTiet" asp-route-thang="@Model.Thang" asp-route-nam="@Model.Nam"
                        class="btn btn-info">
                        <i class="fas fa-list"></i> Chi tiết
                    </a>
                    <a asp-action="TongHop" asp-route-thang="@Model.Thang" asp-route-nam="@Model.Nam"
                        class="btn btn-success">
                        <i class="fas fa-chart-pie"></i> Tổng hợp
                    </a>
                </div>
            </div>

            <!-- Thông tin tháng -->
            <div class="alert alert-primary">
                <h5><i class="fas fa-calendar-alt"></i> Dashboard tháng @Model.Thang/@Model.Nam</h5>
                <p class="mb-0">Tổng quan thống kê sử dụng bàn ăn</p>
            </div>

            <!-- Các chỉ số tổng quan -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-layer-group fa-2x mb-2"></i>
                            <h5 class="card-title">Tổng loại bàn</h5>
                            <h2>@Model.TongSoLoaiBan</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-table fa-2x mb-2"></i>
                            <h5 class="card-title">Tổng bàn có sẵn</h5>
                            <h2>@Model.TongSoBanCoSan</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h5 class="card-title">Bàn đã sử dụng</h5>
                            <h2>@Model.TongSoBanDaSuDung</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-percentage fa-2x mb-2"></i>
                            <h5 class="card-title">Tỷ lệ sử dụng</h5>
                            <h2>@Model.TyLeSuDungChung.ToString("F1")%</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Biểu đồ và bảng thống kê -->
            <div class="row">
                <!-- Biểu đồ cột -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-column"></i> Biểu đồ tỷ lệ sử dụng bàn theo loại
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="usageChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bảng thống kê nhanh -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-table"></i> Thống kê nhanh</h5>
                        </div>
                        <div class="card-body">
                            @if (Model.ThongKeTrungBinh.Any())
                            {
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Loại bàn</th>
                                                    <th>Tỷ lệ (%)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in Model.ThongKeTrungBinh.OrderByDescending(x =>
                                                                                                                                                                            x.ty_le_su_dung_trung_binh_ngay))
                                                {
                                                        <tr>
                                                            <td>@item.ten_loai_ban</td>
                                                            <td>
                                                                <div class="progress" style="height: 15px;">
                                                                    <div class="progress-bar @(item.ty_le_su_dung_trung_binh_ngay > 70 ? "bg-success" : item.ty_le_su_dung_trung_binh_ngay > 40 ? "bg-warning" : "bg-danger")"
                                                                        style="width: @(Math.Min(item.ty_le_su_dung_trung_binh_ngay, 100))%">
                                                                        @item.ty_le_su_dung_trung_binh_ngay.ToString("F1")%
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                            }
                            else
                            {
                                    <div class="alert alert-warning text-center">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <p class="mb-0">Không có dữ liệu</p>
                                    </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Biểu đồ tròn -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Phân bố số bàn theo loại</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="distributionChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line"></i> Xu hướng sử dụng bàn</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="trendChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bảng chi tiết -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-list"></i> Chi tiết thống kê</h5>
                        </div>
                        <div class="card-body">
                            @if (Model.ThongKeTrungBinh.Any())
                            {
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Loại bàn</th>
                                                    <th>Số ngày có đơn</th>
                                                    <th>TB bàn sử dụng/ngày</th>
                                                    <th>TB lần đặt bàn/ngày</th>
                                                    <th>TB số khách/ngày</th>
                                                    <th>Tỷ lệ sử dụng (%)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in Model.ThongKeTrungBinh)
                                                {
                                                        <tr>
                                                            <td><span class="badge bg-primary">@item.ten_loai_ban</span></td>
                                                            <td>@item.so_ngay_co_don_trong_thang</td>
                                                            <td>@item.trung_binh_ban_su_dung_ngay.ToString("F2")</td>
                                                            <td>@item.trung_binh_lan_dat_ban_ngay.ToString("F2")</td>
                                                            <td>@item.trung_binh_so_khach_ngay.ToString("F2")</td>
                                                            <td>
                                                                <span
                                                                    class="badge @(item.ty_le_su_dung_trung_binh_ngay > 70 ? "bg-success" : item.ty_le_su_dung_trung_binh_ngay > 40 ? "bg-warning" : "bg-danger")">
                                                                    @item.ty_le_su_dung_trung_binh_ngay.ToString("F1")%
                                                                </span>
                                                            </td>
                                                        </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            $(document).ready(function () {
                // Dữ liệu cho biểu đồ
                const thongKeData = @Html.Raw(Json.Serialize(Model.ThongKeTrungBinh));

                // Biểu đồ cột - Tỷ lệ sử dụng
                const usageCtx = document.getElementById('usageChart').getContext('2d');
                new Chart(usageCtx, {
                    type: 'bar',
                    data: {
                        labels: thongKeData.map(item => item.ten_loai_ban),
                        datasets: [{
                            label: 'Tỷ lệ sử dụng (%)',
                            data: thongKeData.map(item => item.ty_le_su_dung_trung_binh_ngay),
                            backgroundColor: thongKeData.map(item =>
                                item.ty_le_su_dung_trung_binh_ngay > 70 ? '#28a745' :
                                    item.ty_le_su_dung_trung_binh_ngay > 40 ? '#ffc107' : '#dc3545'
                            ),
                            borderColor: thongKeData.map(item =>
                                item.ty_le_su_dung_trung_binh_ngay > 70 ? '#1e7e34' :
                                    item.ty_le_su_dung_trung_binh_ngay > 40 ? '#e0a800' : '#bd2130'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                // Biểu đồ tròn - Phân bố số bàn
                const distributionCtx = document.getElementById('distributionChart').getContext('2d');
                new Chart(distributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: thongKeData.map(item => item.ten_loai_ban),
                        datasets: [{
                            data: thongKeData.map(item => item.tong_ban_su_dung_thang),
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Biểu đồ đường - Xu hướng
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: thongKeData.map(item => item.ten_loai_ban),
                        datasets: [{
                            label: 'TB bàn sử dụng/ngày',
                            data: thongKeData.map(item => item.trung_binh_ban_su_dung_ngay),
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'TB lần đặt bàn/ngày',
                            data: thongKeData.map(item => item.trung_binh_lan_dat_ban_ngay),
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        </script>
}
